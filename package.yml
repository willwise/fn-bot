AWSTemplateFormatVersion: 2010-09-09
Description: fn-bot
Transform:
- AWS::Serverless-2016-10-31
Parameters:
  Workload:
    Type: String
    Default: dev
    Description: The type of workload (environment) that this stack will run
  OsApiKey:
    Type: String
    Default: mGvGWUtOi5aRYpACv6PyiofCOPkNOhPG
    Description: The key for the ordinance survey API
Resources:
  speakToCouncilFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/speakToCouncil/speak-to-council.speakToCouncil
      Runtime: nodejs12.x
      MemorySize: 128
      Timeout: 100
      Description: A Lambda function that returns a static string.
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonDynamoDBReadOnlyAccess
      Environment:
        Variables:
          OS_API_KEY:
            Fn::Sub:
            - ${OsApiKey}
            - OsApiKey:
                Ref: OsApiKey
          TABLE_NAME:
            Ref: fnBotServicesTable
      CodeUri: s3://fn-bot-sam-package/49e7550c3e59a19607aeb5d80b509a9a
  fnBotServicesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: ServiceName
        AttributeType: S
      KeySchema:
      - AttributeName: ServiceName
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      StreamSpecification:
        StreamViewType: NEW_IMAGE
  bulkServiceUpload:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/bulkServiceUpload/bulk-upload.bulkUpload
      Runtime: nodejs12.x
      MemorySize: 128
      Timeout: 100
      Description: A Lambda function that returns a static string.
      Policies:
      - AWSLambdaBasicExecutionRole
      - AmazonDynamoDBFullAccess
      - AmazonS3ReadOnlyAccess
      Environment:
        Variables:
          TABLE_NAME:
            Ref: fnBotServicesTable
          BUCKET:
            Ref: fnBotServicesBucket
      CodeUri: s3://fn-bot-sam-package/49e7550c3e59a19607aeb5d80b509a9a
  fnBotServicesBucket:
    Type: AWS::S3::Bucket
  fnBotUpdateSlots:
    Type: AWS::Serverless::Function
    Properties:
      Handler: rebuildBot.rebuildBot
      Runtime: nodejs12.x
      CodeUri: s3://fn-bot-sam-package/76f3fec8b87309f31740059ffaa76027
      Description: An Amazon DynamoDB trigger that logs the updates made to a table.
      MemorySize: 128
      Timeout: 23
      Policies:
      - CloudWatchFullAccess
      - AmazonDynamoDBFullAccess
      - AmazonLexFullAccess
      - AWSLambdaBasicExecutionRole
      Events:
        Stream:
          Type: DynamoDB
          Properties:
            Stream:
              Fn::GetAtt:
              - fnBotServicesTable
              - StreamArn
            BatchSize: 1
            StartingPosition: LATEST
      Environment:
        Variables:
          SLOT_NAME:
            Ref: serviceSlot
          INTENT_NAME:
            Ref: speakToCouncilIntent
          BOT_NAME:
            Ref: fnBot
  CreateFNBotSingleServicesRecord:
    Type: AWS::Serverless::Function
    Properties:
      Handler: createSingleItem.createSingleItem
      Runtime: nodejs12.x
      CodeUri: s3://fn-bot-sam-package/a6b33837cb46dae717b4157cef015934
      Description: ''
      MemorySize: 128
      Timeout: 3
      Policies:
      - AmazonDynamoDBFullAccess
      - AWSLambdaBasicExecutionRole
      Environment:
        Variables:
          TABLE_NAME:
            Ref: fnBotServicesTable
  serviceSlot:
    Type: Custom::LexSlotType
    Properties:
      ServiceToken:
        Fn::ImportValue: cfn-lex-slot-type-1-0-3-ServiceToken
      name:
        Fn::Sub:
        - ${AWS::StackName}_service_type_${Workload}
        - Workload:
            Ref: Workload
      description: a list of council services
      valueSelectionStrategy: TOP_RESOLUTION
      enumerationValues:
      - value: testing
        synonyms:
        - test
  speakToCouncilIntent:
    Type: Custom::LexIntent
    DependsOn:
    - serviceSlot
    Properties:
      ServiceToken:
        Fn::ImportValue: cfn-lex-intent-1-0-3-ServiceToken
      name:
        Fn::Sub:
        - ${AWS::StackName}_speak_to_council_sam_${Workload}
        - Workload:
            Ref: Workload
      confirmationPrompt:
        maxAttempts: 1
        messages:
        - content: test
          contentType: PlainText
      fulfillmentActivity:
        type: ReturnIntent
      dialogCodeHook:
        uri:
          Fn::GetAtt:
          - speakToCouncilFunction
          - Arn
        messageVersion: 1.0
      sampleUtterances:
      - I want {service}
      slots:
      - name: service
        description: what service do you want
        priority: 1
        slotConstraint: Required
        slotType:
          Ref: serviceSlot
        slotTypeVersion: $LATEST
        valueElicitationPrompt:
          maxAttempts: 2
          messages:
          - content: What service do you want?
            contentType: PlainText
  fnBot:
    Type: Custom::LexBot
    DependsOn:
    - speakToCouncilIntent
    Properties:
      ServiceToken:
        Fn::ImportValue: cfn-lex-bot-1-0-4-ServiceToken
      name:
        Fn::Sub:
        - ${AWS::StackName}fn_bot_sam_${Workload}
        - Workload:
            Ref: Workload
      abortStatement:
        messages:
        - content: I dont understand
          contentType: PlainText
      childDirected: false
      clarificationPrompt:
        maxAttempts: 1
        messages:
        - content: I'm sorry, I didn't hear that. Can you repeate what you just said?
          contentType: PlainText
      description: BOT
      voiceId: Joanna
      idleSessionTTLInSeconds: 300
      intents:
      - intentName:
          Ref: speakToCouncilIntent
        intentVersion: $LATEST
      locale: en-US
      processBehavior: BUILD
  fnBotPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
        - speakToCouncilFunction
        - Arn
      Principal: lex.amazonaws.com
